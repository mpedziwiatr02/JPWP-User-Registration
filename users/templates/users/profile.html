{% extends 'base.html' %}

{% block title %}Twój profil{% endblock title %}

{% block head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock head %}

{% block content %}

<h1 class="text-center mt-2">Twój profil</h1>

<form method="POST">
    {% csrf_token %}
    <div class="row justify-content-center">
        <div class="col-md-3 mx-3">
            <div class="form-group mb-3">
                {% for field in sensitive_form %}
                    <p>
                        <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                        {% if field.errors %}
                            <ul class="errorlist">
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                        {{ field }}
                    </p>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-3 mx-3">
                {% for field in user_form %}
                    <p>
                        <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                        {% if field.errors %}
                            <ul class="errorlist">
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                        {{ field }}
                    </p>
                {% endfor %}
                {% for field in profile_form %}
                    <p>
                        <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                        {% if field.errors %}
                            <ul class="errorlist">
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                        {{ field }}
                    </p>
                {% endfor %}
        </div>
        <div class="col-md-3 mx-3">
                {% for field in location_form %}
                    <p>
                        <label class="form-label" for="{{ field.auto_id }}">{{ field.label }}</label>
                        {% if field.errors %}
                            <ul class="errorlist">
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                        {{ field }}
                    </p>
                {% endfor %}
        </div>
    </div>
    <div class="d-flex justify-content-center">
        <button type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-md mb-2">Zapisz zmiany</button>
    </div>
</form>

{% if users.profile.avatar %}
    <img src="{{ users.profile.avatar.url }}" alt="Avatar" />
{% endif %}

<script type="text/javascript">
    var subdivisionsDict = {{ subdivisions_dict | safe }};

    $(document).ready(function() {

        var $region = $('#id-region');

        function populateRegions(country) {
            $region.empty();
            $region.append('<option value=""></option>');

            if (country in subdivisionsDict) {
                var subdivisions = subdivisionsDict[country];
                $.each(subdivisions, function(index, name) {
                    $region.append('<option value="' + name + '">' + name + '</option>');
                });
            }
        }

        var country = $('#id-country').val();
        var region = "{{ location_form.instance.region }}";
        
        if (country) {
            populateRegions(country);
        }

        if (region) {
            $region.val(region);
        }

        $('#id-country').change(function() {
            var country = $(this).val();
            populateRegions(country);
        });

    });
</script>

{% endblock content %}